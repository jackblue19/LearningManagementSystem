@page
@model LMS.Pages.Teacher.TeacherAttendanceModel
@{
    ViewData["Title"] = "ƒêi·ªÉm danh h·ªçc vi√™n";
}

<div class="container mt-4">
    <h2>ƒêi·ªÉm danh h·ªçc vi√™n</h2>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @Model.Message
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.Schedule != null)
    {
        <!-- Schedule Info -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5>Th√¥ng tin bu·ªïi h·ªçc</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>L·ªõp h·ªçc:</strong> @Model.Schedule.Class?.ClassName</p>
                        <p><strong>Ng√†y h·ªçc:</strong> @Model.Schedule.SessionDate.ToString("dd/MM/yyyy")</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Th·ªùi gian:</strong> @Model.Schedule.StartTime - @Model.Schedule.EndTime</p>
                        <p><strong>Ph√≤ng:</strong> @Model.Schedule.RoomName</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Quick Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Thao t√°c nhanh</h5>
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="QuickMark" style="display:inline;">
                <input type="hidden" name="scheduleId" value="@Model.ScheduleId" />
                <input type="hidden" name="markAll" value="present" />
                <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-check-all"></i> ƒê√°nh d·∫•u t·∫•t c·∫£ "C√≥ m·∫∑t"
                </button>
            </form>
            <form method="post" asp-page-handler="QuickMark" style="display:inline;">
                <input type="hidden" name="scheduleId" value="@Model.ScheduleId" />
                <input type="hidden" name="markAll" value="absent" />
                <button type="submit" class="btn btn-danger me-2">
                    <i class="bi bi-x-circle"></i> ƒê√°nh d·∫•u t·∫•t c·∫£ "V·∫Øng m·∫∑t"
                </button>
            </form>
        </div>
    </div>

    <!-- Attendance Form -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Danh s√°ch ƒëi·ªÉm danh</h5>
            <span class="badge bg-primary">@Model.Students.Count h·ªçc vi√™n</span>
        </div>
        <div class="card-body">
            @if (Model.Students.Any())
            {
                <form method="post">
                    <input type="hidden" asp-for="ScheduleId" />
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>Email</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.AttendanceInputs.Count; i++)
                                {
                                    <tr>
                                        <td>@(i + 1)</td>
                                        <td>
                                            <input type="hidden" asp-for="AttendanceInputs[i].StudentId" />
                                            <strong>@Model.AttendanceInputs[i].StudentName</strong>
                                        </td>
                                        <td>
                                            @{
                                                var student = Model.Students.FirstOrDefault(s => s.UserId == Model.AttendanceInputs[i].StudentId);
                                            }
                                            @student?.Email
                                        </td>
                                        <td>
                                            <select asp-for="AttendanceInputs[i].Status" class="form-select form-select-sm">
                                                <option value="present" selected="@(Model.AttendanceInputs[i].Status == "present")">
                                                    ‚úì C√≥ m·∫∑t
                                                </option>
                                                <option value="absent" selected="@(Model.AttendanceInputs[i].Status == "absent")">
                                                    ‚úó V·∫Øng m·∫∑t
                                                </option>
                                                <option value="late" selected="@(Model.AttendanceInputs[i].Status == "late")">
                                                    ‚è∞ ƒêi mu·ªôn
                                                </option>
                                                <option value="excused" selected="@(Model.AttendanceInputs[i].Status == "excused")">
                                                    üìù C√≥ ph√©p
                                                </option>
                                            </select>
                                        </td>
                                        <td>
                                            <input asp-for="AttendanceInputs[i].Note" 
                                                   class="form-control form-control-sm" 
                                                   placeholder="Ghi ch√∫..." />
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> L∆∞u ƒëi·ªÉm danh
                        </button>
                        <a asp-page="TeacherDashboard" class="btn btn-secondary btn-lg ms-2">
                            <i class="bi bi-arrow-left"></i> Quay l·∫°i
                        </a>
                    </div>
                </form>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-people display-1 text-muted"></i>
                    <p class="text-muted mt-3">Kh√¥ng c√≥ h·ªçc vi√™n n√†o trong l·ªõp n√†y.</p>
                </div>
            }
        </div>
    </div>

    <!-- Statistics -->
    @if (Model.Attendances.Any())
    {
        <div class="card mt-4">
            <div class="card-header">
                <h5>Th·ªëng k√™ ƒëi·ªÉm danh</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3 bg-success bg-opacity-10 rounded">
                            <h3 class="text-success">@Model.Attendances.Count(a => a.StudentStatus == "present")</h3>
                            <p class="mb-0">C√≥ m·∫∑t</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-danger bg-opacity-10 rounded">
                            <h3 class="text-danger">@Model.Attendances.Count(a => a.StudentStatus == "absent")</h3>
                            <p class="mb-0">V·∫Øng m·∫∑t</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-warning bg-opacity-10 rounded">
                            <h3 class="text-warning">@Model.Attendances.Count(a => a.StudentStatus == "late")</h3>
                            <p class="mb-0">ƒêi mu·ªôn</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-info bg-opacity-10 rounded">
                            <h3 class="text-info">@Model.Attendances.Count(a => a.StudentStatus == "excused")</h3>
                            <p class="mb-0">C√≥ ph√©p</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto-save indicator
        document.querySelector('form').addEventListener('submit', function() {
            const btn = this.querySelector('button[type="submit"]');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang l∆∞u...';
            btn.disabled = true;
        });
    </script>
}

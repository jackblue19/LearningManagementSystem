@page
@model LMS.Pages.Admin.Feedbacks.IndexModel
@{
    ViewData["Title"] = "Feedback Management";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Feedback Management</h2>
    </div>

    @if (TempData["SuccessMessage"] is string success)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @success
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] is string error)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @error
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form method="get" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="SearchTerm" class="form-label">Search</label>
                <input type="text" class="form-control" id="SearchTerm" name="SearchTerm"
                       value="@Model.SearchTerm" placeholder="Content, class, or user">
            </div>
            <div class="col-md-3">
                <label for="StatusFilter" class="form-label">Status</label>
                <select class="form-select" id="StatusFilter" name="StatusFilter">
                    <option value="">All</option>
                    @foreach (var status in Model.ViewModel.StatusOptions)
                    {
                        <option value="@status" selected="@(Model.StatusFilter == status)">@status</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label for="VisibilityFilter" class="form-label">Visibility</label>
                <select class="form-select" id="VisibilityFilter" name="VisibilityFilter">
                    <option value="">All</option>
                    <option value="true" selected="@(Model.VisibilityFilter == true)">Visible</option>
                    <option value="false" selected="@(Model.VisibilityFilter == false)">Hidden</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary w-100">Filter</button>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>User</th>
                    <th>Class</th>
                    <th>Rating</th>
                    <th>Status</th>
                    <th>Visibility</th>
                    <th>Content</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.ViewModel.Feedbacks.Items.Any())
                {
                    @foreach (var feedback in Model.ViewModel.Feedbacks.Items)
                    {
                        <tr>
                            <td>@feedback.CreatedAt.ToString("yyyy-MM-dd")</td>
                            <td>
                                <div class="fw-semibold">@feedback.Username</div>
                                <small class="text-muted">@feedback.FullName</small>
                            </td>
                            <td>@feedback.ClassName</td>
                            <td>
                                @if (feedback.Rating.HasValue)
                                {
                                    <span class="badge bg-warning text-dark">@feedback.Rating / 5</span>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-info">@feedback.FbStatus ?? "unknown"</span>
                            </td>
                            <td>
                                @if (feedback.IsVisible)
                                {
                                    <span class="badge bg-success">Visible</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Hidden</span>
                                }
                            </td>
                            <td style="max-width: 300px;">
                                @if (!string.IsNullOrWhiteSpace(feedback.Content))
                                {
                                    <div class="text-truncate" title="@feedback.Content">
                                        @feedback.Content
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">No content</span>
                                }
                            </td>
                            <td>
                                <div class="d-flex flex-column gap-2">
                                    <form method="post" asp-page-handler="UpdateStatus" class="d-flex gap-2">
                                        <input type="hidden" name="id" value="@feedback.FeedbackId" />
                                        <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                                        <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" />
                                        <input type="hidden" name="VisibilityFilter" value="@Model.VisibilityFilter" />
                                        <input type="hidden" name="PageIndex" value="@Model.PageIndex" />

                                        <select name="status" class="form-select form-select-sm">
                                            @foreach (var status in Model.ViewModel.StatusOptions)
                                            {
                                                <option value="@status" selected="@(feedback.FbStatus == status)">@status</option>
                                            }
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                                    </form>
                                    <form method="post" asp-page-handler="UpdateVisibility" class="d-flex gap-2">
                                        <input type="hidden" name="id" value="@feedback.FeedbackId" />
                                        <input type="hidden" name="isVisible" value="@(feedback.IsVisible ? "false" : "true")" />
                                        <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                                        <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" />
                                        <input type="hidden" name="VisibilityFilter" value="@Model.VisibilityFilter" />
                                        <input type="hidden" name="PageIndex" value="@Model.PageIndex" />
                                        <button type="submit" class="btn btn-sm @(feedback.IsVisible ? "btn-outline-warning" : "btn-outline-success")">
                                            @(feedback.IsVisible ? "Hide" : "Show")
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="text-center">No feedback found.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (Model.ViewModel.Feedbacks.TotalCount > 0)
    {
        <nav aria-label="Feedback pagination">
            <ul class="pagination justify-content-center">
                @if (Model.ViewModel.Feedbacks.PageIndex > 1)
                {
                    <li class="page-item">
                        <a class="page-link" asp-page="Index"
                           asp-route-SearchTerm="@Model.SearchTerm"
                           asp-route-StatusFilter="@Model.StatusFilter"
                           asp-route-VisibilityFilter="@Model.VisibilityFilter"
                           asp-route-PageIndex="@(Model.ViewModel.Feedbacks.PageIndex - 1)">Previous</a>
                    </li>
                }

                @{
                    var totalPages = (int)Math.Ceiling((double)Model.ViewModel.Feedbacks.TotalCount / Model.ViewModel.Feedbacks.PageSize);
                }

                @for (int i = Math.Max(1, Model.ViewModel.Feedbacks.PageIndex - 2);
                     i <= Math.Min(totalPages, Model.ViewModel.Feedbacks.PageIndex + 2);
                     i++)
                {
                    <li class="page-item @(i == Model.ViewModel.Feedbacks.PageIndex ? "active" : "")">
                        <a class="page-link" asp-page="Index"
                           asp-route-SearchTerm="@Model.SearchTerm"
                           asp-route-StatusFilter="@Model.StatusFilter"
                           asp-route-VisibilityFilter="@Model.VisibilityFilter"
                           asp-route-PageIndex="@i">@i</a>
                    </li>
                }

                @if (Model.ViewModel.Feedbacks.PageIndex < totalPages)
                {
                    <li class="page-item">
                        <a class="page-link" asp-page="Index"
                           asp-route-SearchTerm="@Model.SearchTerm"
                           asp-route-StatusFilter="@Model.StatusFilter"
                           asp-route-VisibilityFilter="@Model.VisibilityFilter"
                           asp-route-PageIndex="@(Model.ViewModel.Feedbacks.PageIndex + 1)">Next</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

